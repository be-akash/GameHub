# render.yaml — Render Blueprint for GameHub (server + web + redis)
services:
  # --- Redis (free tier) ---
  - type: redis
    name: dd-redis
    ipAllowList: []           # private by default
    plan: free

  # --- API (Fastify + Socket.IO) ---
  - type: web
    name: dd-api
    env: node
    plan: free
    region: frankfurt         # pick the closest region
    runtime: node
    rootDir: apps/server
    buildCommand: |
      corepack enable
      pnpm i --frozen-lockfile
      pnpm build
    startCommand: node dist/index.js
    autoDeploy: true
    healthCheckPath: /health
    envVars:
      # Render provides PORT; Fastify must listen on this PORT
      - key: PORT
        value: "10000"

      # CORS: allow the web app’s origin (injected from the web service URL)
      - key: CORS_ORIGIN
        fromService:
          name: dd-web
          type: web
          property: url

      # Redis URL injected from the managed Redis instance
      - key: REDIS_URL
        fromService:
          name: dd-redis
          type: redis
          property: connectionString

  # --- Web (Next.js) ---
  - type: web
    name: dd-web
    env: node
    plan: free
    region: frankfurt
    runtime: node
    rootDir: apps/web
    buildCommand: |
      corepack enable
      pnpm i --frozen-lockfile
      pnpm build
    startCommand: pnpm start
    autoDeploy: true
    envVars:
      # Public base URL for HTTP API
      - key: NEXT_PUBLIC_API_URL
        fromService:
          name: dd-api
          type: web
          property: url
      # Public base URL for Socket.IO — https URL is fine; socket.io will use WSS
      - key: NEXT_PUBLIC_WS_URL
        fromService:
          name: dd-api
          type: web
          property: url
