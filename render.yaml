services:
  # --- Redis instance ---
  - type: redis
    name: gamehub-redis
    ipAllowList: []  # accessible only to linked services

  # --- Fastify + Socket.IO server ---
  - type: web
    name: gamehub-api
    env: node
    plan: free
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @dashanddots/server build
    startCommand: pnpm --filter @dashanddots/server start
    autoDeploy: true
    envVars:
      - key: REDIS_URL
        fromService:
          type: redis
          name: gamehub-redis
          property: connectionString
      - key: CORS_ORIGIN
        value: https://gamehub-web.onrender.com

  # --- Next.js frontend ---
  - type: web
    name: gamehub-web
    env: node
    plan: free
    buildCommand: >
      pnpm install --frozen-lockfile &&
      pnpm --filter @dashanddots/web build
    startCommand: pnpm --filter @dashanddots/web start
    autoDeploy: true
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: https://gamehub-api.onrender.com
      - key: NEXT_PUBLIC_WS_URL
        value: https://gamehub-api.onrender.com
